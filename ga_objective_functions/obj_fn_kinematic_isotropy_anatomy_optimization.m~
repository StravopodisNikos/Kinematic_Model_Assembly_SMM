function MB_star = obj_fn_kinematic_isotropy_anatomy_optimization(x,extracted_structure,extracted_assembly_parameters)
% This function optimizes the anatomy of a smm manipulator structure w.r.t kinematic
% isotropy condition. the structure MUST previously be extracted.

%% x: structure definition-parameterization chromosome
% Chromosome x is built considering the smm structure building principles
% defined and the parameters given in the corresponding xacro file used for
% visualization

% x1-4 = since 3dof, 4 pseudos are max
ci = x(1:4); 

%% Obtain matlab_ws folder path on the pc
current_path = cd; % pc-grafeio
root_path = string(split(current_path,'matlab_ws'));
root_path = root_path(1);

ga_path_relative_to_matlab_ws = fullfile('matlab_ws','Kinematic_Model_Assembly_SMM','ga_objective_functions','subroutines_executed_in_objective_fn',filesep);
ga_library_path = strcat(root_path,ga_path_relative_to_matlab_ws); addpath(ga_library_path);


terminate_ga_obj_fn = false;    % used to control ga

%% I.  Assign structure parameters values
logical wrong_string_structure;
fixed_active_string_notation = 'x0';
passive_under_string_notation = '21';

%  I.1 Assembly sequence definition
% Since no stribg values are produced in ga, matching must be first made
% for x1,x2,x3
%% Determine tpi pseudojoint angles
step_angle = deg2rad(45);
tpi0 = -1.5708;
for k=1:4
    tp(k) = step_angle * (floor(ci(k))-1) + tpi0;
end

%% II. Structure assembly
[xi_ai_ref,xi_pj_ref,g_ai_ref,g_pj_ref,gst0,M_s_com_k_i,g_s_com_k_i,wrong_string_structure] = structure_assembly_3dof(extracted_structure,extracted_assembly_parameters);

if wrong_string_structure
    MB_star = 10000000;
    terminate_ga_obj_fn = true;
end

if terminate_ga_obj_fn==false
    
% II.1 FWD KINEMATICS @ Reference Anatomy and configuration
% nDoF = size(xi_ai_ref,2);
% nPseudo = size(xi_pj_ref,2); 

% qa = zeros(nDoF,1);     % Reference Configuration
% qp = zeros(nPseudo,1);  % Reference Anatomy
% [~,~,~,Pi_i1_ref,~] = calculateForwardKinematicsPOE(structure,xi_ai_ref,xi_pj_ref,qa,qp,g_ai_ref,g_pj_ref,gst0);

%% III. Compute CoMi and Ms,Mb of metamorphic links @ Reference Anatomy
%[g_s_link_as_ref,M_s_link_as_ref] = calculateCoMmetalinks(M_s_com_k_i,g_s_com_k_i);
%[M_b_link_as_ref] = calculateMetalinkInertiaMatrixBody(g_s_link_as_ref,M_s_link_as_ref);

%% IV. MBS  @ Reference Anatomy
% MBS_ref = calculateMBS_no_graph(structure,assembly_parameters,xi_ai_ref,xi_pj_ref,qp);

%% V. Anatomy Richness - Here starts anatomy exhaustive calculation
[max_MBS_anat] = calculateExhaustiveAnatomies_for_MBS(extracted_structure,extracted_assembly_parameters,'max',xi_ai_ref,xi_pj_ref);

%% V. Final structure score
MB_star = max_MBS_anat;
end

end